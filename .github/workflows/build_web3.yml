name: build Web3 Gateway
on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - uses: Kaven-Universe/github-action-current-date-time@v1
          id: date
          with:
            format: 'YYYYMMDD'
        - name: short time
          id: short_time
          run: |
            val="${{ steps.date.outputs.time }}"
            echo "last6=${val: -6}" >> $GITHUB_OUTPUT
        - name: Checkout
          uses: actions/checkout@v4
        - name: Setup Rust
          uses: dtolnay/rust-toolchain@stable
          with:
            toolchain: stable
            targets: x86_64-unknown-linux-musl
        - name: Setup Needed Packages
          run: |
            sudo apt update
            sudo apt install -y musl-tools
        - name: install buckyos devkit
          run: pip install "buckyos-devkit @ git+https://github.com/buckyos/buckyos-devkit.git"
        - name: Build
          working-directory: ./src
          run: buckyos-build --app=web3-gateway
        - name: Build metadata
          id: build_meta
          run: |
            echo "tag=$(date -u +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
        - name: Package
          run: |
            tar -czf web3-gateway-${{ steps.build_meta.outputs.tag }}.tar.gz -C ./src web3-gateway
        - name: Upload Artifact
          uses: actions/upload-artifact@v4
          with:
            name: web3-gateway-build${{ steps.short_time.outputs.last6 }}
            path: ./src/web3-gateway
            if-no-files-found: error
        - name: Upload Release Asset
          uses: softprops/action-gh-release@v2
          with:
            tag_name: web3-gateway-${{ steps.build_meta.outputs.tag }}
            name: web3-gateway-${{ steps.build_meta.outputs.tag }}
            files: web3-gateway-${{ steps.build_meta.outputs.tag }}.tar.gz
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
