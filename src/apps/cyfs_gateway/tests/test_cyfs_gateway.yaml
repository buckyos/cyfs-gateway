limiters:
  - id: global
    download_limit: 1GB/s
    upload_limit: 1GB/s
    concurrent: 2048

  - id: test
    upper_limiter: global
    download_limit: 1MB/s
    upload_limit: 1MB/s
    concurrent: 256

stacks:
  - id: test1
    bind: 0.0.0.0:18080
    protocol: tcp
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              http-probe && call-server ${REQ.dest_host};
              reject;

  - id: test2
    bind: 0.0.0.0:18081
    protocol: tcp
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              http-probe && call-server ${REQ.dest_host};
              reject;

  - id: test3
    bind: 0.0.0.0:9545
    protocol: udp
    transparent: false
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              call-server main_dns;

servers:
  - id: web3.buckyos.com
    type: http
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              starts-with ${REQ.path} "/api" && rewrite ${REQ.path} "/api*" "*" && map-add REQ host www.buckyos.com && forward http://127.0.0.1:18081;
          - id: default1
            block: |
              starts-with ${REQ.path} "/sn" && rewrite ${REQ.path} "/sn*" "/*" && call-server sn.http;
              call-server web3_dir;

  - id: www.buckyos.com
    type: http
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              call-server www_dir;

  - id: web3_dir
    type: dir
    root_dir: {{web3_dir}}

  - id: www_dir
    type: dir
    root_dir: {{www_dir}}

  - id: main_dns
    type: dns
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              resolve ${REQ.name} ${REQ.record_type} local_dns && return;
              resolve ${REQ.name} ${REQ.record_type} "223.5.5.5:53" && return;

  - id: sn
    type: sn
    host: web3.buckyos.io
    ip: 127.0.0.1
    zone_config_jwt: test
    zone_config_pkx: test

  - id: local_dns
    type: local_dns
    path: {{local_dns}}

global_process_chains:
  - id: global_test1
    priority: 1
    blocks:
      - id: default
        block: |
          call-server ${REQ.dest_host}
