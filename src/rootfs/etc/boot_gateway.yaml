stacks:
  test1:
    bind: 0.0.0.0:8080
    protocol: tcp
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              call https-sni-probe && return "forward rtcp://home.zhicong.me:2980/${REQ.dest_host}:443";
              call http-probe  && return "forward rtcp://home.zhicong.me:2980/${REQ.dest_host}:80";
              eq ${REQ.ext.method} "CONNECT" && return "forward tcp:///${REQ.dest_host}";
              return "forward tcp:///${REQ.dest_host}:80";

  test2:
    bind: 0.0.0.0:5235
    protocol: tcp
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              reject;

  test3:
    bind: 0.0.0.0:9545
    protocol: udp
    transparent: false
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              return "server main_dns";

#  test5:
#    bind: 0.0.0.0:2980
#    protocol: rtcp
#    key_path: ./rootfs/etc/device.key.pem
#    device_config_path: ./rootfs/etc/device.doc.json
#    hook_point:
#      - id: main
#        priority: 1
#        blocks:
#          - id: default
#            block: |
#              reject;
#
#  test8083_tls:
#    bind: 0.0.0.0:8083
#    protocol: tls
#    certs:
#      - domain: "web3.buckyos.com"
#        cert_file: ./cert.pem
#        key_file: ./key.pem
#    hook_point:
#      - id: main
#        priority: 1
#        blocks:
#          - id: default
#            block: |
#              reject;
#
#  test8083_quic:
#    bind: 0.0.0.0:8083
#    protocol: quic
#    certs:
#      - domain: "web3.buckyos.com"
#        cert_file: ./cert.pem
#        key_file: ./key.pem
#    hook_point:
#      - id: main
#        priority: 1
#        blocks:
#          - id: default
#            block: |
#              reject;

servers:
  #    web3.buckyos.com:
#    type: http
#    hook_point:
#      - id: main
#        priority: 1
#        blocks:
#          - id: default
#            block: |
#              reject;
#
  #  proxy:
  #  type: socks5
#    hook_point:
#      - id: main
#        priority: 1
#        blocks:
#          - id: default
#            block: |
#              reject;
#
  main_dns:
    type: dns
    hook_point:
      - id: main
        priority: 1
        blocks:
          - id: default
            block: |
              call resolve ${REQ.name} ${REQ.record_type} local_dns && return;
              call resolve ${REQ.name} ${REQ.record_type} "223.5.5.5:53" && return;
