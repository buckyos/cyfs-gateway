stacks:
  test1:
    bind: 0.0.0.0:8080
    protocol: tcp
    hook_point:
      main:
        priority: 1
        blocks:
          default:
            priority: 1
            block: |
              call https-sni-probe && return "forward rtcp://home.zhicong.me:2980/${REQ.dest_host}:443";
              call http-probe  && return "forward rtcp://home.zhicong.me:2980/${REQ.dest_host}:80";
              eq ${REQ.ext.method} "CONNECT" && return "forward tcp:///${REQ.dest_host}";
              return "forward tcp:///${REQ.dest_host}:80";

  test2:
    bind: 0.0.0.0:5235
    protocol: tcp
    hook_point:
      main:
        priority: 1
        blocks:
          default:
            block: |
              reject;

  test3:
    bind: 0.0.0.0:9545
    protocol: udp
    transparent: false
    hook_point:
      main:
        priority: 1
        blocks:
          default:
            priority: 1
            block: |
              return "server main_dns";

#  test5:
#    bind: 0.0.0.0:2980
#    protocol: rtcp
#    key_path: ./rootfs/etc/device.key.pem
#    device_config_path: ./rootfs/etc/device.doc.json
#    hook_point:
#      main:
#        priority: 1
#        blocks:
#          default:
#            block: |
#              reject;

  test8083_tls:
    bind: 0.0.0.0:443
    protocol: tls
    certs:
      - domain: "*"
    hook_point:
      main:
        blocks:
          default:
            block: |
              return "forward tcp:///tls://${REQ.dest_host}:443";

#
#  test8083_quic:
#    bind: 0.0.0.0:8083
#    protocol: quic
#    certs:
#      - domain: "web3.buckyos.com"
#        cert_path: ./cert.pem
#        key_path: ./key.pem
#    hook_point:
#      main:
#        priority: 1
#        blocks:
#          default:
#            block: |
#              reject;

servers:
  #    web3.buckyos.com:
#    type: http
#    hook_point:
  #      main:
#        priority: 1
#        blocks:
  #          default:
#            block: |
#              reject;
#
  #  proxy:
  #  type: socks5
#    hook_point:
  #      main:
#        priority: 1
#        blocks:
  #          default:
#            block: |
#              reject;
#
  main_dns:
    type: dns
    hook_point:
      main:
        priority: 1
        blocks:
          default:
            priority: 1
            block: |
              call resolve ${REQ.name} ${REQ.record_type} local_dns && return;
              call resolve ${REQ.name} ${REQ.record_type} "223.5.5.5:53" && return;
