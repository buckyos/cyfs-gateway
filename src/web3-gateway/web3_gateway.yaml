includes:
  - path: params.json
  - path: website.yaml

servers:
  web3_sn:
    id: web3_sn
    type: sn
    host: "{{sn_host}}"
    boot_jwt: "{{sn_boot_jwt}}"
    owner_pkx: "{{sn_owner_pk}}"
    device_jwt: ["{{sn_device_jwt}}"]
    ip: "{{sn_ip}}"

  local_dns:
    type: local_dns
    file_path: local_dns.toml

  main_dns:
    id: main_dns
    type: dns
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              call resolve ${REQ.name} ${REQ.record_type} local_dns && return;
              call resolve ${REQ.name} ${REQ.record_type} web3_sn && return;

  main_http:
    type: http
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              eq ${REQ.host} "sn.{{sn_host}}" && return "server web3_sn";
              map-create "QUESTION" && map-add "QUESTION" "dest_host" "${REQ.host}" && map-add "QUESTION" "method" "query_by_hostname";
              call qa "web3_sn" "QUESTION" && eq ${ANSWER.self_cert} "true" && return "forward rtcp://${ANSWER.did_hostname}/:80";
stacks:
  dns_udp:
    bind: 0.0.0.0:53
    protocol: udp
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              return "server main_dns";

  main_rtcp:
    bind: 0.0.0.0:2980
    protocol: rtcp
    key_path: ./sn_private_key.pem
    device_config_path: ./sn_device_config.json
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              map-add "REQ" "method" "query_by_did"
              call qa "web3_sn" "REQ" && eq ${ANSWER.state} "active" && accept;
              reject;

  main_http_tcp:
    bind: 0.0.0.0:80
    protocol: tcp
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              return "server main_http";
  
  main_tls:
    bind: 0.0.0.0:3443
    protocol: tls
    certs:
      - domain: "sn.{{sn_host}}"
        cert_path: ./{{sn_cer}}
        key_path: ./{{sn_pem}}
      - domain: "*.web3.{{sn_host}}"
        cert_path: ./{{web3_cer}}
        key_path: ./{{web3_pem}}
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              return "server main_http";

  tls_raw_forward:
    bind: 0.0.0.0:443
    protocol: tcp
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              call https-sni-probe || reject; 
              match ${REQ.dest_host} "sn.{{sn_host}}" && return "forward tcp:///:3443";
              match ${REQ.dest_host} "www.{{sn_host}}" && return "forward tcp:///:3443";
              match ${REQ.dest_host} "{{sn_host}}" && return "forward tcp:///:3443";
              map-create "QUESTION" && map-add "QUESTION" "dest_host" "${REQ.dest_host}" && map-add "QUESTION" "method" "query_by_hostname";
              call qa "web3_sn" "QUESTION" && eq ${ANSWER.self_cert} "true" && return "forward rtcp://${ANSWER.did_hostname}/:443";
              match ${REQ.dest_host} "*.web3.{{sn_host}}" && return "forward tcp:///:3443";
              reject;
  


