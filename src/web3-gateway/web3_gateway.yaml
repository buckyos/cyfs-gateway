includes:
  - path: params.json
  - path: website.yaml

servers:
  web3_sn:
    id: web3_sn
    type: sn
    host: "sn.{{sn_host}}"
    boot_jwt: "eyJhbGciOiJFZERTQSJ9.eyJvb2RzIjpbInNuIl0sImV4cCI6MjA1ODgzODkzOX0.SGem2FBRB0H2TcRWBRJCsCg5PYXzHW9X9853UChV_qzWHHhKxunZ-emotSnr9HufjL7avGEos1ifRjl9KTrzBg"
    owner_pkx: "qJdNEtscIYwTo-I0K7iPEt_UZdBDRd4r16jdBfNR0tM"
    device_jwt: ["eyJhbGciOiJFZERTQSJ9.eyJuIjoic24iLCJ4IjoiRlB2WTNXWFB4dVdQWUZ1d09ZMFFiaDBPNy1oaEtyNnRhMWpUY1g5T1JQSSIsImV4cCI6MjA1ODgzODkzOX0._YKR0y6E4JQJXDEG12WWFfY1pXyxtdSuigERZQXphnQAarDM02JIoXLNtad80U7T7lO_A4z_HbNDRJ9hMGKhCA"]
    ip: "{{sn_ip}}"

  main_dns:
    id: main_dns
    type: dns
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              call resolve ${REQ.name} ${REQ.record_type} web3_sn && return;

  main_http:
    type: http
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              eq ${REQ.host} "sn.{{sn_host}}" && return "server web3_sn";
              map-add "REQ" "method" "query_by_hostname"
              call qa "web3_sn" "REQ" && eq ${ANSWER.state} "active" && return "forward rtcp://${ANSWER.did_hostname}/:443";
stacks:
  dns_udp:
    bind: 0.0.0.0:53
    protocol: udp
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              return "server main_dns";

  main_rtcp:
    bind: 0.0.0.0:2980
    protocol: rtcp
    key_path: ./sn_private_key.pem
    device_config_path: ./sn_device_config.json
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              map-add "REQ" "method" "query_by_did"
              call qa "web3_sn" "REQ" && eq ${ANSWER.state} "active" && accept;
              reject;

  main_http_tcp:
    bind: 0.0.0.0:80
    protocol: tcp
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              return "server main_http";
  
  main_tls:
    bind: 0.0.0.0:3443
    protocol: tls
    certs:
      - domain: "sn.{{sn_host}}"
        cert_path: ./fullchain.cert
        key_path: ./fullchain.pem
      - domain: "*.web3.{{sn_host}}"
        cert_path: ./fullchain.cert
        key_path: ./fullchain.pem
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              return "server main_http";

  tls_raw_forward:
    bind: 0.0.0.0:443
    protocol: tcp
    hook_point:
      main:
        id: main
        priority: 1
        blocks:
          default:
            id: default
            priority: 1
            block: |
              call https-sni-probe || reject; 
              match ${REQ.dest_host} "sn.{{sn_host}}" && return "forward tcp:///127.0.0.1:3443";
              match ${REQ.dest_host} "www.{{sn_host}}" && return "forward tcp:///127.0.0.1:3443";
              match ${REQ.dest_host} "{{sn_host}}" && return "forward tcp:///127.0.0.1:3443";
              map-create "QUESTION" && map-add "QUESTION" "dest_host" "${REQ.dest_host}" && map-add "QUESTION" "method" "query_by_hostname";
              call qa "web3_sn" "QUESTION" && eq ${ANSWER.self_cert} "true" && return "forward rtcp://${ANSWER.did_hostname}/:443";
              reject;
  


