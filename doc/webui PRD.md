# CYFS‑Gateway Dashboard 产品需求文档（PRD）

* 产品名称：CYFS‑Gateway Dashboard（WebUI）
* 文档版本：v1.0
* 面向版本：v1（旁路由 Router Mode 优先）
* 作者: GPT 5.2
* 负责人：产品（你）/ 需求工程团队 / 研发
* 日期：2026-01-24

---

## 1. 背景与目标

### 1.1 背景

cyfs‑gateway 是一个 local‑first 的网关工具箱，核心差异是 process‑chain（规则脚本）可动态调整路由/转发/阻断/改写等策略，并且配置体系支持 include 分层与 overlay 机制。Dashboard 作为 Web 控制面板，目标是把“家庭旁路由场景”做成可用、可解释、可回滚的体验，同时保留运维/开发者调试入口，但不把复杂度强塞给家庭用户。

### 1.2 产品目标（v1）

1. **家庭用户优先**：在旁路由模式下，让用户能完成三件事：

   * 看得懂当前网络工作状态（总览、设备、链路）
   * 能配置“规则（脚本）”并安全生效（语法校验、明确优先级、可回滚）
   * 能管理“链路（Tunnel/Link）”并一键验证（大网站连通性/出口 IP/用量）
2. **工程化可运维**：配置是 include 合成的大 JSON，支持远程 include 自动更新并自动生效；本地编辑走草稿/校验/生效/回滚闭环，并保证 show merged config、diff、回滚等基本能力。
3. **能力边界清晰**：

   * cyfs‑gateway 内核不关心“怎么把流量导入透明栈”，这部分系统相关；Dashboard 不直接操作 iptables，只提供状态/指引/入口（另有 Linux 脚本）。
   * 规则生成：v1 **纯离线 copy/paste**，Dashboard 不内置直连 LLM。
4. **高风险能力可控**：TLS 拦截（MITM）作为独立功能，默认关闭，启用后才解锁相关页面能力；默认仅对“选中设备”生效，提供 CA 生成/下载、重新生成的强提示与紧急关闭。

### 1.3 非目标（v1 不做/不承诺）

* 不在 Dashboard 内实现系统级旁路由安装（不直接改 iptables/路由表/网卡），只提供脚本入口/状态检查/排错信息。
* 不做“LLM 一键生成规则”（无 API Key 集成），仅做提示词生成与粘贴回填。
* 不做“家庭用户友好版全量日志分析”；日志面板定位为开发者现场调试（类似系统日志），默认不在家庭模式曝光。
* 不承诺复杂的计费闭环：本地统计用量；若链路配置了查询 API，可展示其返回状态（余额/套餐等），但不做支付/扣费。

---

## 2. 用户画像与使用场景

### 2.1 用户优先级

1. 家庭用户（主）：关心可用性、规则是否生效、孩子设备是否按预期、不同网站是否能访问、出口 IP 是谁、用量是多少。
2. 运维（次）：关心对象（stack/server/chain）状态、流量、日志、快速定位问题。
3. 开发者（最低）：主要用 CLI；Dashboard 主要用日志/对象树辅助调试。

### 2.2 典型场景（v1 必须覆盖）

* S1：家庭用户想让某个设备/某类网站走某条 tunnel，并希望可验证（Google/YouTube/Netflix/Baidu 等）。
* S2：家庭用户启用“儿童友好 tag”类规则，限制设备访问不合适站点（基于 TagDB tag）。
* S3：移动 App 测试：一键启用某个“测试环境文件（LAN host/zone）”，把指定域名指向测试环境。
* S4：运维排障：远程 token 登录，查看对象/日志，定位链路故障与规则命中问题。
* S5：高级用户启用 TLS 拦截，对选中设备进行 HTTP header 级探测（body 仅副本 writer 用于分析，不主打拦截）。

---

## 3. 核心概念与名词规范（产品口径统一）

### 3.1 对象模型（运行时心智）

* **stack**：网络入口（bind/捕获），协议栈（tcp/udp/tls/rtcp…）
* **server**：应用层服务（socks/http/dns/自定义 server）
* **process‑chain**：规则引擎（hook_point → blocks → block 脚本）

两条典型路径（对 UI 的解释用语）：

1. server 模式：client → server → process‑chain → forward/reject/…
2. 透明栈模式（旁路由）：traffic capture stack → process‑chain → forward/accept/reject

### 3.2 process‑chain 最小语义（用于“规则管理”说明）

* 从上到下顺序执行
* `cmd1 && cmd2` 短路
* 变量形如 `${REQ.xxx}`
* 遇到终止指令结束（forward/return/reject/accept）

> UI 需要把“优先级=顺序”讲清楚；规则冲突的本质就是链上顺序/终止条件。

### 3.3 Link / Tunnel / Stream URL（统一抽象）

* 统一“转发目标”的表达：
  `$协议名://$tunnelid/$streamid`
   在 PRD 中统称为 **基于Tunnel 的Stream URL** 体系，UI 允许用户拼接/测试。

### 3.4 配置分层（include + overlay）

* 配置入口文件通过 include 合成大配置；include 顺序决定覆盖顺序。建议存在 `post_gateway.json` 作为 overlay 层，运行态差量（或 UI 写入）优先落在 post 层，避免污染稳定层。

### 3.5 Post 规则规范（本 PRD 的强约束）

* **用户在 Dashboard 创建/编辑的规则**属于“Post 规则”，默认挂载到 **最高优先级的 Post 节点**（你定义为规范）。
* **来自配置文件 include 的规则**在 UI 中只读，不参与拖拽排序。

---

## 4. 产品范围（v1 功能清单）

### 4.1 模式与导航（全局）

* UI 模式：Router Mode（默认）、Ops Mode、Developer Mode
* 模式切换：系统设置中切换；切换后左侧导航、默认首页、可见功能不同。

### 4.2 v1 必做模块（Router Mode）

1. 概览（工作状态）
2. 设备（列表/详情）
3. 链路（Tunnel）管理（列表/详情/新增/启用禁用/一键测试）
4. 规则（自然语言→提示词→脚本粘贴→语法校验→生效；Post 规则排序）
5. 数据库（订阅库只读、自定义库可编辑；含 GeoIP）
6. 测试（预置大网站测试，结果以日志/trace 为主）
7. 配置管理（合成配置查看、草稿编辑、diff、校验、生效、回滚、远程 include 同步）
8. TLS 拦截（独立开关 + CA 管理 + 设备范围）
9. 安全（本地免登录、远程 token/密码）
10. 导入导出（多类型导出、单入口导入、影响预览）

### 4.3 v1 次要模块（Ops/Developer）

* Ops：stack/server/process‑chain 关键指标、详情页日志跳转、SDK 构造请求/跑链路（以 log/trace 为结果）。
* Developer：日志面板（raw/trace 聚合/过滤）、连接面板（tunnel/stream 列表与过滤）、对象树、（可选）iptables/nft 规则查看并生成“解释提示词”。

---

## 5. 信息架构与页面结构

### 5.1 Router Mode 左侧导航（建议）

* 概览
* 设备
* 链路（Tunnel）
* 规则
* 数据库
* 测试
* 配置
* 系统设置
* （隐藏/高级）开发者面板：日志、连接、对象树

> 家庭用户默认进入 Router Mode，并且“对象树”默认隐藏（需要切 Developer Mode 或显式入口）。

---

## 6. 详细需求

> 下面每个模块写：目标 / 功能点 / 关键交互 / 验收标准。

---

### 6.1 概览（工作状态面板）

#### 6.1.1 目标

让家庭用户快速判断“现在网关是否正常、走的是什么链路、是否有拦截、是否有异常”。

#### 6.1.2 展示内容（v1）

* 总流量曲线（10s 刷新）
* 总请求数/连接数趋势（10s 刷新）
* 分类统计（至少提供两种维度切换）：

  * 按设备（TopN）
  * 按链路 tunnel（TopN）
  * 按动作（直连/代理/拦截/失败）
* “系统健康”卡片：

  * gateway 运行状态
  * 最近一次配置生效时间
  * 远程 include 自动更新状态（最近检查时间、是否成功、是否自动生效）
  * TLS 拦截：开/关、覆盖设备数

#### 6.1.3 验收标准

* 页面加载 < 2s（本地）
* 数据刷新不阻塞操作；10s 刷新可关闭为手动刷新（低端设备兜底）

---

### 6.2 设备模块

#### 6.2.1 目标

以“设备”为中心配置策略范围与 TLS 拦截范围。

#### 6.2.2 数据来源与字段规范

* 必有字段：`device_name`、`src_ip`、`src_mac` 也必须可用。
* 设备增强：旁路由侧可提供独立 Device API，用于查询更详细的设备信息（厂商/类型/备注/图标/最近在线等）。增强失败不影响基础使用。

#### 6.2.3 设备列表（v1）

* 默认展示字段（最小集）：

  * 设备名
  * IP
  * （可扩展字段区）：按配置/Device API 动态扩展（例如 MAC、在线、速率、今日用量、TLS 状态、命中规则次数…）
* 支持操作：

  * 搜索（按设备名/IP）
  * 进入设备详情
  * 勾选设备（用于 TLS 拦截范围/批量操作）

#### 6.2.4 设备详情页（v1）

* 基础信息：设备名/IP/MAC（如可得）、增强信息（如可得）
* TLS 拦截状态（若功能已启用）：该设备是否在拦截范围内、证书提示
* 规则命中概览（只读）：最近命中 Post 规则 TopN（帮助解释“为什么被拦截/为什么走代理”）
* （可选）设备级快捷策略（模板化入口，不在 v1 强制）

#### 6.2.5 验收标准

* 设备列表能承载至少 256 台设备（分页/虚拟列表）
* 设备增强 API 不可用时，设备模块仍可工作（只用 IP/MAC/默认名）

---

### 6.3 链路（Tunnel/Link）模块

#### 6.3.1 目标

让用户管理可用 tunnel 资源，并在需要时选择/验证链路。

#### 6.3.2 链路定义

* Link = tunnel（资源）；可通过 Tunnel URL/Stream URL 访问 target（统一抽象）。
* tunnel 支持复用：tunnel_id 打开一次后可长期复用（资源驻留）。

#### 6.3.3 链路列表页（v1）

* 展示字段（必须）：

  * 延迟
  * 带宽
  * 当前吞吐
  * 当前用量（本地统计）
  * 出口 IP
  * 启用状态（开关）
* 支持：

  * 进入详情
  * 启用/禁用
  * 一键测试（可从详情或列表快速入口）

刷新：10s（与系统统一）

#### 6.3.4 链路新增（v1，强约束：不做表单）

* 交互：

  * PC：粘贴一段**编码后的 JSON 文本**（本质 JSON，但会做编码）
  * 移动端：扫码导入（二维码内容等价于上述文本）
* UI 行为：

  1. 粘贴/扫码后自动解析
  2. 展示“预览卡片”（tunnel_id、schema、（如能解析）endpoint/备注/计费信息）
  3. 语法/结构校验通过后允许保存
  4. 保存后默认“禁用”或“启用”（建议默认启用，但可配置；v1 推荐默认启用以减少步骤）

失败时：

* 解析失败：给出错误位置/原因 + 示例
* 校验失败：说明缺失字段（以 schema 的要求为准）

#### 6.3.5 链路详情页（v1）

* 基础指标：延迟/带宽/吞吐/用量/出口 IP
* 最近测试记录（至少保留最近 20 次）
* （可选）计费/状态：若 tunnel 配置了查询 API，则展示其返回状态（余额/套餐/限额等）

#### 6.3.6 一键测试（v1）

* 目标集合：预置大网站（Google/YouTube/Netflix/Baidu 等）
* 结果呈现：**以日志/trace 为主**（你明确“就是日志”）

  * 每次测试生成一个 trace-id
  * UI 自动跳转到日志页并预过滤该 trace-id
  * 可选显示一个非常轻量的摘要（成功/失败、出口 IP），但不强制（避免与“日志为主”冲突）

#### 6.3.7 验收标准

* 新增链路：粘贴文本→解析预览→保存≤30s 完成
* 一键测试：点击后 3s 内在 UI 有“已触发/trace-id”反馈（即使链路慢也要先反馈）

---

### 6.4 规则模块（核心）

#### 6.4.1 目标

让家庭用户在不理解底层脚本细节的情况下，仍能完成“写规则→校验→生效→可解释→可回滚”。

#### 6.4.2 规则分类与权限

* **Post 规则（可编辑）**：由 Dashboard 创建/编辑，默认挂载到最高优先级 Post 节点（规范）。支持拖拽排序。
* **配置规则（只读）**：来自 include 合成配置，UI 只读展示，不允许编辑/拖拽。

#### 6.4.3 规则列表页（v1）

每条规则显示：

* 规则名称（可选）
* 自然语言描述（用户输入的原始需求）
* 最终规则脚本（可折叠）
* 启用开关（对 Post 规则生效；只读规则无开关或显示“由配置管理”）
* 规则来源：Post / include 文件路径（只读规则必须标注来源）
* 命中统计（可选 v1.1；v1 可以先不做）

操作：

* 新建规则
* 编辑 Post 规则
* 拖拽排序（仅 Post 规则）
* 复制脚本 / 导出规则

#### 6.4.4 新建规则流程（v1：纯离线）

1. 用户输入自然语言需求（例如“某设备在某时段访问某类网站走代理”）
2. UI 生成 Prompt（包含：规则规范、可用变量、示例、用户需求）
3. 用户复制 prompt → 去 ChatGPT 生成脚本
4. 用户把脚本粘贴回 Dashboard
5. **语法校验（至少）**通过后，按钮“生效/应用”可点击（F2）
6. 点击“生效/应用”后写入 Post overlay 并触发网关重载（实现由基础设施决定，PRD只要求产品闭环）

校验要求（v1 最低要求）：

* 脚本语法合法（能够被解析）
* 基础静态检查（推荐做，但可由 infra 团队决定优先级）：

  * 明显非法的 stream url
  * 引用缺失（如果能做）
  * unreachable（如果能做）
    （内部文档倾向“严格校验：加载阶段尽可能发现错误”）

失败体验：

* 展示错误消息（可复制）
* 保留用户输入与脚本，不丢失
* 支持“重新校验”

#### 6.4.5 规则优先级与拖拽（v1）

* 仅 Post 规则支持拖拽排序
* UI 必须提示“从上到下顺序执行，终止指令会停止执行”
* 拖拽后需要“应用”生效（同样走校验→应用）

#### 6.4.6 dest_host 决策逻辑（产品解释口径）

* 优先：TLS SNI / HTTP Host 探测
* 非 HTTP 协议：走 IP→Host 库查询
* DNS Response 观察结果是否写入 IP→Host 库由规则决定；拦截侧只依赖 IP→Host 库（稳定输入）

#### 6.4.7 验收标准

* 用户可在 3 分钟内完成：自然语言→提示词→粘贴脚本→校验→生效
* 校验失败时提示可读（包含错误原因/位置/建议）
* 规则来源/只读边界明确，不会让用户误以为配置规则可编辑

---

### 6.5 数据库模块（TagDB / IP 知识库 / GeoIP / IP→DNS）

#### 6.5.1 目标

提供“可查询、可解释、可订阅”的知识库管理能力；并严格区分“订阅库只读、自定义库可编辑”。

#### 6.5.2 DB 列表与实现约束

* 每类 DB 独立，目前 sqlite（实现细节不在 PRD 强制，但要在导入导出中体现“可离线携带”）
* DB 类型（v1）：

  * Hostname TagDB
  * IP TagDB
  * IP→Host DB（核心）
  * IP→GEO DB（补充：你指出漏掉）
  * IP→DNS DB（如与 IP→Host 合并也可，但 UI 概念上提供“IP 反查 hostname”入口）
  * LAN Host/Zone 环境（见 6.6）

#### 6.5.3 数据来源与同步

* 订阅：通过 URL 下载（IP→Host、IP→GEO 等）
* Probe：对浏览行为探测（包括 DNS Response）；写入与否由规则决定
* 同步策略：

  * remote include 的同步模式由 include 配置决定
  * 配置为自动更新的 remote include：**每 30 分钟检查一次，并自动生效**（你确认 B2）

#### 6.5.4 读写权限规则（强约束）

* **订阅库**：只读展示；任何修改都会被同步刷新覆盖，因此 UI 不提供编辑入口
* **自定义库**：可增删改；用于覆盖订阅结果

冲突优先级（你确认推荐方案）：

* **自定义库覆盖订阅库**（同 key 冲突时自定义优先）

#### 6.5.5 查询能力（v1）

* Hostname TagDB：按 hostname 查询 tags；按 tag 反查 hostnames（可选）
* IP TagDB：按 IP/网段查询 tags
* IP→Host：输入 IP，返回 hostname（可多值）、来源（订阅/探测/自定义）、更新时间
* IP→GEO：输入 IP，返回 GEO 信息、来源、更新时间
* “测试当前一个 IP 对应的 hostname”：**只查询 DB，不做在线反查**（你明确）

#### 6.5.6 验收标准

* 查询响应 < 300ms（本地数据）
* 订阅库与自定义库的边界清晰（UI 明确标注“只读/可编辑”）

---

### 6.6 LAN Host / Zone 环境（移动 App 测试）

#### 6.6.1 目标

让测试人员用“一个环境一个文件”的方式快速切换整体 DNS/host 结果。

#### 6.6.2 功能点（v1）

* 环境列表：环境名、启用状态、优先级（可选）、更新时间
* 环境详情：展示配置内容（只读），支持复制
* 新增环境：粘贴配置文本（已有格式），保存
* enable/disable：一键启用/停用一个完整环境
* 冲突策略（建议写清楚）：

  * 多环境同时启用时，按优先级/最后启用覆盖（由你们现有格式决定；若已有规则，按现有）

---

### 6.7 测试模块（Scenario Runner）

#### 6.7.1 目标

提供“可复现的一键触发”，并把结果落到日志/trace（你明确 D=日志）。

#### 6.7.2 功能点（v1）

* 预置测试集：大网站列表（可配置）
* 测试维度：

  * 默认：用系统当前策略跑
  * （可选）指定 tunnel 对比（v1 不强制）
* 结果：

  * 触发后生成 trace-id
  * 自动跳转日志页，预过滤 trace-id
  * 允许导出本次测试的 trace 日志片段（可选）

---

### 6.8 日志模块（Developer Panel）

#### 6.8.1 产品定位

典型开发者现场调试面板（类似 Windows 系统日志），家庭用户默认不看，但功能必须存在。

#### 6.8.2 功能点

* raw log 实时滚动
* 按 trace-id 聚合查看
* 过滤：关键字、时间范围、对象（tunnel_id / device / server 等可选）
* 与测试联动：测试页生成 trace-id → 日志页一键定位

---

### 6.9 连接模块（Developer Panel：tunnel/stream）

#### 6.9.1 目标

让运维/开发者查看系统维护的 tunnel/stream，关注数量与带宽消耗。

#### 6.9.2 功能点

* tunnel 列表（量不大）：数量、带宽、状态、对应 tunnel_id
* stream 列表（量大）：必须支持过滤/分页

  * 基础过滤：tunnel_id、device_ip、协议、时间
  * HTTP stream 额外过滤：host/path（如可得）、状态码（可选）

---

### 6.10 TLS 拦截（MITM）功能（独立模块、强风险）

#### 6.10.1 目标

为高级用户提供 HTTPS 探测能力：可见 HTTP header；body 仅副本 writer 用于分析，不主打直接拦截。

#### 6.10.2 启用与 gating（强约束）

* TLS 拦截为独立功能开关：

  * 未启用：相关页面入口隐藏或置灰（并提示“启用后可用”）
  * 启用后：才允许配置“对哪些设备生效”、才解锁相关规则变量（如 http header）

#### 6.10.3 生效范围（v1）

* 默认：对“选中设备”生效（设备来自设备列表勾选）
* 可切换：

  * 对全部设备生效
  * 通过规则生效（高级）

#### 6.10.4 CA 证书管理（v1 必做）

* 生成/下载 CA
* 重新生成 CA（强提示：会导致已安装设备失效）
  -（建议 v1.1）展示指纹/有效期、安装指引（iOS/Android/Windows/macOS）

#### 6.10.5 风险提示（必须写入 UI 文案）

* 高价值高风险：需要设备安装自定义根证书；可能造成兼容性/隐私/合规风险
* 提供“紧急关闭”入口（例如顶栏红色开关）
* 说明基本流程与处理路径（概念一致性）：生成 CA → tls 栈配置证书替换 → 导向 smart_http_server → http_server 的 process-chain 中访问请求并落盘/改写

---

### 6.11 配置管理（Config）

#### 6.11.1 目标

把“include 合成配置”做成可见、可验证、可回滚的闭环。

#### 6.11.2 核心能力（v1 必做）

* 查看当前合成配置（include 展开 + params 替换后的最终结果）

  * 输出需稳定（便于 diff）
  * 敏感字段脱敏（JWT/私钥等）
* 本地编辑：

  * 草稿区编辑（立即模式修改但不生效）
  * diff 预览（当前生效 vs 草稿）
  * 校验（schema + 引用完整性 + 基础规则质量）
  * “生效/应用”按钮（需要二次确认）
  * 生效失败：自动回退到上一版（产品要求，不限制实现）
* 回滚：

  * 至少支持“一键回滚上一版”
    -（建议）保留最近 N 个版本

#### 6.11.3 remote include 同步（v1）

* include 项可设置同步模式：手动/自动
* 自动更新：每 30 分钟检查一次
* 你确认：**检查到更新后自动生效**
* 异常处理（产品要求）：

  * 若新版本校验失败：继续使用上一版本，并在概览页提示“自动更新失败”
  * 若自动生效导致服务异常：应提供一键回滚到上一版本（依赖 6.11.2 的版本机制）

> 这里建议把“自动更新自动生效”限定在“被标记为 auto_apply 的 include”，避免所有远程配置都自动改爆。

---

### 6.12 系统设置与安全

#### 6.12.1 基础设置

* 版本信息
* 语言设置
* 颜色模式
* 系统托盘入口（仅提供快速打开浏览器入口）
* UI 模式切换（Router / Developer / Ops）
* 许可证查看

#### 6.12.2 安全设置（v1）

* 127.0.0.1 访问免授权
* 远程访问需要授权：

  * 长效 API Token（支持多个、可命名、可撤销）
  * 登录密码（可选，若启用则与 token 策略并存或互斥由实现定）
* Dashboard 端口设置、生成访问 URL（用于本机快捷打开/局域网访问）

---

### 6.13 导入导出

#### 6.13.1 导出类型（v1）

* 完整导出：可在不能上网的机器导入并生效（包含同步到的 DB）
* 全部配置导出
* 用户配置导出（post overlay + user 层）
* 链路导出（tunnel 相关）

导出文件格式：7z（实现细节不在 PRD 强约束，但体验上作为单文件交付）

#### 6.13.2 导入（v1）

* 单入口导入
* 导入后先做“影响预览”：

  * 将会新增/覆盖哪些配置层
  * 将会新增/覆盖哪些 DB
  * 将会新增/覆盖哪些 tunnel
* 用户确认后执行导入，并给出结果（成功/失败、失败原因、回滚入口）

---

## 7. 非功能性需求（NFR）

### 7.1 性能与容量

* 页面加载：核心页面（概览/设备/链路/规则）本地打开 < 2s
* 刷新频率：默认 10s（你确认）
* stream 列表：支持大量数据时的分页/过滤（避免一次性渲染卡死）

### 7.2 可用性与安全

* 配置/规则生效必须可回滚（至少回滚上一版）
* remote include 自动生效必须有失败兜底（校验失败不替换、自动提示）
* TLS 拦截必须默认关闭、强提示、可紧急关闭

### 7.3 可观测性

* 所有“测试触发/规则生效/配置生效/远程同步”都必须产生日志事件（便于追溯）
* trace-id：用于串起一次测试/一次请求链路（日志页按 trace 聚合）

---

## 8. 关键交互流程（文字版）

### 8.1 新建规则（离线）

自然语言 → 生成 Prompt（复制） → 用户去 ChatGPT 生成脚本 → 粘贴脚本 → 语法校验 → 用户确认生效 → 写入 Post 规则（最高优先级 Post 节点）→ 重载/热更新 → 日志记录

### 8.2 新增链路（粘贴/扫码）

粘贴/扫码 → 解析预览 → 校验 → 保存 → （可选）启用 → 一键测试 → 自动跳转日志（trace-id）

### 8.3 TLS 拦截启用

系统设置开启 TLS 拦截 → 生成/下载 CA → 用户安装到选中设备 → 设备列表勾选生效范围 → 相关规则/探测能力解锁 → （异常）紧急关闭

### 8.4 remote include 自动更新

后台每 30 分钟检查 → 若有更新：拉取 → 校验 → 自动生效 → 记录“自动生效事件” → 概览显示最新状态
若失败：保留旧版本 + 错误提示 + 支持手动重试/回滚

---

## 9. 风险与对策

1. **TLS MITM 合规/隐私风险**

* 对策：默认关闭 + 强提示 + 设备范围默认最小化 + 紧急关闭 + 证书重新生成强提示

2. **remote include 自动生效可能引发网络中断**

* 对策：严格校验 + 失败不替换 + 一键回滚 + 在概览页给出“最近一次自动生效/失败”可见性

3. **规则冲突导致行为不可解释**

* 对策：Post 规则拖拽排序 + 明确“顺序执行/终止指令”提示 +（建议）规则命中统计/trace 解释

4. **旁路由系统侧脚本差异大**

* 对策：Dashboard 不承担系统改造，仅给“接入状态/脚本入口/排错提示”；并在 Developer 面板提供必要的系统状态查看（可选）。

---

## 10. 验收清单（v1）

### Router Mode（必过）

* 设备列表可见（至少设备名+IP），支持搜索，支持勾选
* 链路列表展示 5 指标（延迟/带宽/吞吐/用量/出口IP），支持启用禁用
* 新增链路：粘贴编码文本可解析预览并保存；支持扫码导入入口
* 一键测试：预置大网站测试，可触发并跳转日志 trace
* 规则：

  * 新建规则走离线提示词流程
  * 脚本粘贴后至少语法校验
  * 生效需要手动确认（F2）
  * Post 规则支持拖拽排序；配置规则只读
* 配置：

  * show 合成配置
  * 草稿编辑 + diff + 校验 + 生效 + 回滚
  * remote include 自动更新（30min）且自动生效，失败有提示且不替换
* TLS 拦截：

  * 独立开关
  * CA 生成/下载、重新生成
  * 默认对选中设备生效
* 安全：

  * 127.0.0.1 免授权
  * token 支持多个、可撤销
* 导入导出：

  * 至少支持“完整导出/导入”
  * 导入前影响预览

### Developer/Ops

* 日志 raw/trace/过滤可用
* 连接面板 tunnel/stream 可过滤可分页
* Ops 模式至少能看到 stack/server 基础指标与日志入口


