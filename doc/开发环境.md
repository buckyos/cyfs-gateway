## 利用虚拟机搭建的开发环境

1. 根据配置创建虚拟机（有的时候需要保持虚拟机的状态，因此该命令一定是手工触发的）
虚拟机会根据配置创建，一般用来模拟 开发机（和服务器在同内网） 服务器，Nat后的OOD
根据配置，虚拟机会构建好基础环境，包括
- 已经就绪的，包含必要基础软件的unbuntu系统
- 网络配置(都是单网卡机器)，包括旁路由设备
- 因为我们的组件里有DNSServer，因此DNS作为基础配置相对比较复杂，要尽可能模拟公网的实际情况
  目前devtests.org系列dns，就是位支持测试准备的(buckyos.io的可能会引起误解)
- 登录配置（可选），方便开发机后续执行SSH指令。默认开发机使用vm control指令执行指令（免去研究开发机如何ssh测试机)

2. 讲编译结果推送到虚拟机
- 停止相关服务
- 推送（分清理数据推送和保留数据推送），默认是保留数据推送

3. 更新配置文件
- 针对测试主机名，用buckycli(或cargo命令）构造所有配置文件  
- 讲配置文件复制到目标主机

4. 启动环境
按顺序，执行特定主机上的命令

5. 启动测试
按顺序，特定主机上的命令
有一些测试指令执行前，可以要求重新启动环境

## 几个buckyos长期使用的典型非单机环境
考虑到multpass宿主机的特性，通过iptalbe封锁端口的方法来实现访问控制（NAT效果）
-- 开发机与SN在同内网（该内网是隔离的独立内网），开开发机有双网卡
-- OOD在一个LAN1中，通过NAT，可以主动访问开发机和SN，但开发机和SN不能主动访问OOD
-- 客户机在另一个LAN中2，通过NAT，可以可以主动访问开发机和SN，不能访问OOD，开发机和SN不能主动访问客户机

## 关键的配置文件
- 3个Zone （Owner,Zone)
- 3个OOD (Device)
- 3个客户端 (Device)
- 1个SN (Device)

## 目前结构的重构
- vm_config.json 定义一组vm 模板 包含镜像，基本硬件配置，基础服务配置
- app_list.json 软件配置，一个软件可以包含一组目录配置和命令配置
- nodes.json 定义node instance,可以引用vm node。此时node instance的网络配置是逻辑网络配置(有lanid)
  - 基于node instance可以调用构造配置文件的命令，命令构造后会写如本地的node_instance/$node_id 目录,然后再将这些目录复制过去
  - node instance中有app list
  - node instance的实例化过程
    - 调用vm 模板定义的初始化命令
    - 调用instance的初始化命令，注意因为instance是顺序初始化的，因此可以引用之前已经instance过的node的信息
    - 安装软件
    - 构造并应用配置
  
- 实例化后可以
  - 停止/启动 特定软件
  - 更新 特定软件（包含配置）
  - 更新 配置


## 构造配置文件的思路

- 环境:SN域名,machine.json
  - https, CA证书，自颁发的SN证书（向下兼容)
  
- 构造用户(包含zone)
  - bob
  - alice

- 基于用户构造设备配置
  - bob.ood1
  - alice.ood1
  - sn_server

- 修改SN的数据库
  - 添加bob
  - 添加alice





